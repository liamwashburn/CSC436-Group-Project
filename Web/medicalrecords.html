<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Records</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="layout-wrapper">
    <main class="content-area">

        <h1>Medical Records for <span id="patient-name" style="color:var(--primary)">Patient</span></h1>

        <div class="main-card">

            <div class="controls-header">
                <h3 style="margin:0; font-weight:600;">Appointment History</h3>
            </div>

            <div class="scroll-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Reason</th>
                            <th>Doctor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody"></tbody>
                </table>
            </div>

        </div>
    </main>

    <nav class="sidebar-right">
        <a href="index.html" class="nav-btn">
            <i class="fa-regular fa-calendar-check"></i>
            Appointments
        </a>
        <a href="billing.html" class="nav-btn">
            <i class="fa-solid fa-file-invoice-dollar"></i>
            Billing
        </a>
        <a href="patients.html" class="nav-btn">
            <i class="fa-solid fa-users"></i>
            Patients
        </a>
        <a href="rooms.html" class="nav-btn">
            <i class="fa-solid fa-door-open"></i>
            Rooms
        </a>
    </nav>
</div>

<script>
/* --- GET pID FROM URL --- */
function getPID() {
    const params = new URLSearchParams(window.location.search);
    return params.get("pID");
}

/* --- LOAD MEDICAL RECORDS --- */
async function loadMedicalRecords() {
    const pID = getPID();
    if (!pID) return;

    const url = `http://127.0.0.1:8000/patients/${pID}/records`;

    try {
        const response = await fetch(url);
        const data = await response.json();
        console.log("Fetched Medical Records:", data);

        renderRecords(data.records || []);

    } catch (error) {
        console.error("Failed to load medical records:", error);
    }
}

/* --- RENDER TABLE ROWS --- */
function renderRecords(records) {
    const tbody = document.getElementById("records-tbody");
    tbody.innerHTML = "";

    records.forEach(record => {
        const dateObj = new Date(record.appTime);
        const date = dateObj.toLocaleDateString();
        const time = dateObj.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${date}</td>
            <td>${time}</td>
            <td>${record.appReason}</td>
            <td>${record.doctorName}</td>
            <td>
                <button class="btn btn-outline" onclick="toggleNotes(${record.appID})">
                    View Notes
                </button>
            </td>
        `;

        const expandRow = document.createElement("tr");
        expandRow.id = `notes-${record.appID}`;
        expandRow.style.display = "none";

        expandRow.innerHTML = `
            <td colspan="5" style="background:#f7f7f7; border-left:4px solid var(--primary);">
                <div style="padding:20px;">
                    <h4 style="margin-bottom:10px;">Doctor Notes</h4>
                    <p style="color:var(--text-main); font-size:0.95rem;">
                        ${record.pNotes || "No notes available."}
                    </p>

                    <div style="margin-top:20px; font-size:0.85rem; color:var(--text-muted);">
                        <strong>Doctor:</strong> ${record.doctorName} (${record.doctorType}) &nbsp; | &nbsp;
                        <strong>Room:</strong> ${record.rID}
                    </div>
                </div>
            </td>
        `;

        tbody.appendChild(tr);
        tbody.appendChild(expandRow);
    });
}

let openNotesID = null;

/* --- EXPAND / COLLAPSE NOTES --- */
function toggleNotes(appID) {
    const newRow = document.getElementById(`notes-${appID}`);

    if (openNotesID && openNotesID !== appID) {
        const oldRow = document.getElementById(`notes-${openNotesID}`);
        if (oldRow) oldRow.style.display = "none";
    }

    if (newRow.style.display === "none") {
        newRow.style.display = "table-row";
        openNotesID = appID;
    } else {
        newRow.style.display = "none";
        openNotesID = null;
    }
}

document.addEventListener("DOMContentLoaded", loadMedicalRecords);
</script>

</body>
</html>