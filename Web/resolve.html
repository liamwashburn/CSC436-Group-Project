<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolve Appointment</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <style>
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 14px;
            border-left: 5px solid var(--primary);
            padding-left: 10px;
        }

        .form-card {
            background: rgba(255,255,255,0.55);
            padding: 25px;
            border-radius: 14px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .resolve-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }
    </style>
</head>

<body>

<div id="success-toast" class="toast-container">
    <i class="fa-solid fa-circle-check"></i>
    <span>Success</span>
</div>

<div class="layout-wrapper">

<main class="content-area">

    <h1>
        Resolve Appointment:
        <span id="resolve-patient-name" style="color: var(--primary);">Loading...</span>
    </h1>

    <div class="main-card">

        <div class="resolve-grid">

            <!-- LEFT -->
            <div>
                <h3 class="section-title">Doctor Summary</h3>
                <div class="form-card">
                    <label>Visit Notes</label>
                    <textarea id="visit-notes" class="form-control summary-box"></textarea>
                </div>
            </div>

            <!-- RIGHT -->
            <div>

                <h3 class="section-title">Billing & Checkout</h3>

                <div class="form-card">

                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-weight:700;">Base Fee</span>
                        <span id="base-fee">$150.00</span>
                    </div>

                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <span>Insurance Coverage</span>
                        <span id="insurance-status">Checking...</span>
                    </div>

                    <hr style="margin:18px 0;">

                    <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:700;">
                        <span>Total Due</span>
                        <span id="total-due">$150.00</span>
                    </div>

                </div>

                <div style="margin-top: 20px; display:flex; flex-direction:column; gap:10px;">
                    <button class="btn btn-primary" onclick="completeResolve()">Complete & Generate Bill</button>
                    <button class="btn btn-outline" onclick="cancelResolve()">Cancel</button>
                </div>

            </div>

        </div>

    </div>

</main>

<nav class="sidebar-right">
    <a href="index.html" class="nav-btn">Appointments</a>
    <a href="billing.html" class="nav-btn">Billing</a>
    <a href="patients.html" class="nav-btn">Patients</a>
</nav>

</div>

<script>
let BASE_FEE = 150;
let insuranceDiscount = 0;

let appID = null;
let pID = null;  // NOW OBTAINED FROM APPOINTMENT LOOKUP

document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);

    appID = params.get("appID");

    if (!appID) {
        alert("Missing appID in URL!");
        return;
    }

    loadAppointmentDetails();
});

async function loadAppointmentDetails() {
    try {
        const res = await fetch(`http://127.0.0.1:8000/appointments/${appID}`);
        const data = await res.json();

        if (!data || !data.appointment) {
            document.getElementById("resolve-patient-name").innerText = "Unknown";
            return;
        }

        const appointment = data.appointment;

        pID = appointment.pID;  // STORE pID from appointment

        document.getElementById("resolve-patient-name").innerText = appointment.pFullName;

        checkInsurance();

    } catch (err) {
        console.error("Failed to load appointment:", err);
        document.getElementById("resolve-patient-name").innerText = "Error loading patient";
    }
}

async function checkInsurance() {
    const box = document.getElementById("insurance-status");

    try {
        const res = await fetch(`http://127.0.0.1:8000/hasInsurance/${pID}`);
        const data = await res.json();

        if (data.hasInsurance) {
            insuranceDiscount = 150;
            box.innerHTML = `<span style="color:green;">- $150 (Covered)</span>`;
        } else {
            insuranceDiscount = 0;
            box.innerHTML = `<span style="color:#991b1b;">No Coverage</span>`;
        }

        updateTotal();
    } catch {
        box.innerText = "Error";
    }
}

function updateTotal() {
    const total = BASE_FEE - insuranceDiscount;
    document.getElementById("total-due").innerText = `$${total}.00`;
}

function completeResolve() {
    const payload = {
        appID: Number(appID),
        bCost: BASE_FEE - insuranceDiscount,
        notes: document.getElementById("visit-notes").value,
    };

    fetch("http://127.0.0.1:8000/medical-records/create", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    }).then(r => {
        if (r.ok) {
            showToast("Resolved & Billed!");
            setTimeout(() => window.location.href = "billing.html", 1500);
        }
    });
}

function cancelResolve() {
    window.location.href = "index.html";
}

function showToast(msg) {
    const toast = document.getElementById("success-toast");
    toast.querySelector("span").innerText = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}
</script>

</body>
</html>